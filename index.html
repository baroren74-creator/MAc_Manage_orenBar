<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>× ×™×”×•×œ ×”×–×× ×•×ª ××§×“×•× ×œ×“'×¡ â€“ ×¡× ×›×¨×•×Ÿ ××ª××©×š</title>
  <style>
    body {
      font-family: sans-serif;
      direction: rtl;
      margin: 20px;
      background-color: #f8f8f8;
    }
    h1, h2 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 8px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px 20px;
      margin-top: 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: right;
    }
    th {
      background-color: #eee;
    }
    .card {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onChildAdded,
      onValue
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // ×”×’×“×¨×•×ª Firebase â€“ ×”×—×œ×™×¤×• ×œ×¢×¨×›×™× ×©×œ ×”×¤×¨×•×™×§×˜ ×©×œ×›× ×× × ×“×¨×©
    const firebaseConfig = {
      apiKey: "AIzaSyBF5lnU86OrzvlcHKNUf0h-2txKLgC5IJo",
      authDomain: "mcd-office-orders.firebaseapp.com",
      databaseURL: "https://mcd-office-orders-default-rtdb.firebaseio.com",
      projectId: "mcd-office-orders",
      storageBucket: "mcd-office-orders.appspot.com",
      messagingSenderId: "10595740776",
      appId: "1:10595740776:web:e59ad7fdbab2f93079dfdd",
      measurementId: "G-XTXX1Q6Y1W"
    };

    // ××ª×—×•×œ Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ××©×ª× ×” ×œ× ×™×”×•×œ ××–×”×” ×”×”×–×× ×” ×”× ×•×›×—×™×ª
    let currentOrderId = null;

    /**
     * ××ª×—×•×œ ×”×¢××•×“:
     * - ×× ×™×© ×¤×¨××˜×¨ orderId ×‘×›×ª×•×‘×ª â€“ ××¦×‘ ××¦×˜×¨×£.
     * - ××—×¨×ª ×× ×™×© orderId ×‘×©××™×¨×ª ×”×“×¤×“×¤×Ÿ â€“ ××¦×‘ ×× ×”×œ ×§×™×™×.
     * - ××—×¨×ª â€“ ×”×¦×’×ª ×˜×•×¤×¡ ×¤×ª×™×—×ª ×”×–×× ×” ×—×“×©×”.
     */
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const orderParam = params.get('orderId');
      if (orderParam) {
        // ××¦×˜×¨×£ ×œ×”×–×× ×”
        currentOrderId = orderParam;
        document.getElementById('managerCard').style.display = 'none';
        document.getElementById('joinCard').style.display = 'block';
        document.getElementById('joinButton').addEventListener('click', submitJoinForm);
      } else {
        // ××¦×‘ ×× ×”×œ â€“ ×‘×“×™×§×” ×× ×§×™×™××ª ×”×–×× ×” ×¤×ª×•×—×” ×‘×“×¤×“×¤×Ÿ
        const savedOrder = localStorage.getItem('managerOrderId');
        if (savedOrder) {
          currentOrderId = savedOrder;
          // ×˜×¢×Ÿ ××ª ×¡×™×›×•× ×”×”×–×× ×” ×•×”××–× ×” ×œ××¦×˜×¨×¤×™×
          showOrderSummary();
          listenForParticipants(currentOrderId);
        }
      }
    });

    /**
     * ×¤×ª×™×—×ª ×”×–×× ×” ×—×“×©×” ×¢"×™ ×”×× ×”×œ
     */
    window.openOrder = function openOrder() {
      const name = document.getElementById('managerName').value.trim();
      const phone = document.getElementById('managerPhone').value.trim();
      const link = document.getElementById('paymentLink').value.trim();
      if (!name) {
        alert('×™×© ×œ×”×–×™×Ÿ ×©× ×× ×”×œ');
        return;
      }
      // ×™×¦×™×¨×ª ×¨×©×•××” ×—×“×©×” ×‘×”×–×× ×•×ª
      const orderRef = push(ref(db, 'orders'));
      currentOrderId = orderRef.key;
      // ×©××™×¨×ª ××–×”×” ×”×”×–×× ×” ×œ×©×™××•×© ×¢×ª×™×“×™
      localStorage.setItem('managerOrderId', currentOrderId);
      // ×©××™×¨×ª ×¤×¨×˜×™ ×”×”×–×× ×” ×‘××¡×“ ×”× ×ª×•× ×™×
      set(ref(db, `orders/${currentOrderId}/details`), {
        managerName: name,
        managerPhone: phone,
        paymentLink: link || '',
        createdAt: new Date().toISOString(),
        status: 'open'
      }).then(() => {
        showOrderSummary();
        listenForParticipants(currentOrderId);
      });
    };

    /**
     * ×”×¦×’×ª ×ª×§×¦×™×¨ ×”×”×–×× ×” ×•×”×§×™×©×•×¨ ×œ×”×¦×˜×¨×¤×•×ª
     */
    function showOrderSummary() {
      document.getElementById('managerCard').style.display = 'none';
      document.getElementById('orderCard').style.display = 'block';
      // ×”×¦×’×ª ×”×§×™×©×•×¨ ×œ×”×¦×˜×¨×¤×•×ª ×œ××©×ª×ª×¤×™× ××—×¨×™×
      const joinUrl =
        `${window.location.origin}${window.location.pathname}?orderId=${currentOrderId}`;
      document.getElementById('joinLinkContainer').innerHTML =
        `<a href="${joinUrl}" target="_blank">${joinUrl}</a>`;
    }

    /**
     * ×××–×™×Ÿ ×œ×”×•×¡×¤×ª ××¦×˜×¨×¤×™× ×•×œ×—×™×©×•×‘ ×¡×›×•× ×›×•×œ×œ
     */
    function listenForParticipants(orderId) {
      const participantsRef = ref(db, `orders/${orderId}/participants`);
      // ×›×œ ××¦×˜×¨×£ ×—×“×©
      onChildAdded(participantsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          addParticipantRow(snapshot.key, data);
        }
      });
      // ×—×™×©×•×‘ ×¡×›×•× ×›×•×œ×œ ×‘×–××Ÿ ×××ª
      onValue(participantsRef, (snapshot) => {
        let total = 0;
        snapshot.forEach(child => {
          const val = child.val();
          total += parseFloat(val.total || 0);
        });
        document.getElementById('summaryTotal').textContent =
          total.toFixed(2) + ' â‚ª';
      });
    }

    /**
     * ×”×•×¡×¤×ª ×©×•×¨×” ×œ×˜×‘×œ×ª ××¦×˜×¨×¤×™× ×‘××¡×š ×”×× ×”×œ
     */
    function addParticipantRow(id, data) {
      const tableBody = document.getElementById('participantsBody');
      // ×‘×“×™×§×” ×× ×›×‘×¨ ×§×™×™××ª ×©×•×¨×” ×¢× ××•×ª×• ID (×œ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª ×‘×¨×™×¢× ×•×Ÿ ×”×“×£)
      if (document.getElementById(id)) {
        return;
      }
      const row = document.createElement('tr');
      row.id = id;
      const itemsStr = Array.isArray(data.items)
        ? data.items.map(i => `${i.name} Ã—${i.qty}`).join(', ')
        : (data.items || '');
      row.innerHTML = `
        <td>${data.restaurant || ''}</td>
        <td>${data.name || ''}</td>
        <td>${data.phone || ''}</td>
        <td>${itemsStr}</td>
        <td>${data.total || 0}</td>
        <td>${data.note || ''}</td>
      `;
      tableBody.appendChild(row);
    }

    /**
     * ×©×œ×™×—×ª ×˜×•×¤×¡ ×”×¦×˜×¨×¤×•×ª ×œ×”×–×× ×”
     */
    function submitJoinForm() {
      const name = document.getElementById('clientName').value.trim();
      const phone = document.getElementById('clientPhone').value.trim();
      const itemsText = document.getElementById('orderItems').value.trim();
      const note = document.getElementById('clientNote').value.trim();
      if (!name) {
        alert('×™×© ×œ×”×–×™×Ÿ ×©×');
        return;
      }
      // ×¤×™×¨×•×§ ×©×•×¨×•×ª ×œ×¨×©×™××ª ×× ×•×ª
      const items = [];
      if (itemsText) {
        itemsText.split(/\n+/).forEach(line => {
          const trimmed = line.trim();
          if (trimmed) {
            items.push({ name: trimmed, qty: 1 });
          }
        });
      }
      const total = 0; // × ×™×ª×Ÿ ×œ×©× ×•×ª ×œ×¤×™ ××—×™×¨×™×
      push(ref(db, `orders/${currentOrderId}/participants`), {
        name: name,
        phone: phone,
        restaurant: '',
        items: items,
        total: total,
        note: note
      }).then(() => {
        document.getElementById('joinCard').innerHTML =
          '<p>×”×”×–×× ×” × ×©×œ×—×”! ×ª×•×“×” ğŸ˜Š</p>';
      });
    }

    /**
     * ×¡×’×™×¨×ª ×”×–×× ×” ×§×™×™××ª (×× ×§×” ××ª ×”× ×ª×•× ×™× ×•×”××—×¡×•×Ÿ ×”××§×•××™)
     */
    window.closeOrder = function closeOrder() {
      if (!currentOrderId) return;
      // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×‘××¡×“ ×”× ×ª×•× ×™×
      set(ref(db, `orders/${currentOrderId}/details/status`), 'closed');
      localStorage.removeItem('managerOrderId');
      // ×¨×¢× ×•×Ÿ ×”×“×£ ×œ××¡×š ×¤×ª×™×—×ª ×”×–×× ×”
      window.location.href = window.location.pathname;
    };
  </script>
</head>
<body>
  <h1>×”×–×× ×•×ª ××§×“×•× ×œ×“'×¡ â€“ × ×™×”×•×œ ×‘×–××Ÿ ×××ª</h1>

  <!-- ×›×¨×˜×™×¡ ×¤×ª×™×—×ª ×”×–×× ×” (×× ×”×œ) -->
  <div id="managerCard" class="card">
    <h2>×¤×ª×™×—×ª ×”×–×× ×” ×—×“×©×”</h2>
    <label for="managerName">×©× ×× ×”×œ</label>
    <input id="managerName" type="text" placeholder="×œ××©×œ: ××•×¨×Ÿ" required>
    <label for="managerPhone">×˜×œ×¤×•×Ÿ ×× ×”×œ</label>
    <input id="managerPhone" type="tel" placeholder="×œ×“×•×’××”: 050-1234567">
    <label for="paymentLink">×§×™×©×•×¨ ×œ×ª×©×œ×•× (××•×¤×¦×™×•× ×œ×™)</label>
    <input id="paymentLink" type="url" placeholder="×§×™×©×•×¨ ×‘×™×˜ / ×¤×™×™×‘×•×§×¡">
    <button onclick="openOrder()">×¤×ª×— ×”×–×× ×”</button>
  </div>

  <!-- ×›×¨×˜×™×¡ ×¡×™×›×•× ×”×–×× ×” (×× ×”×œ) -->
  <div id="orderCard" class="card" style="display: none;">
    <h2>×”×–×× ×” ×¤×¢×™×œ×”</h2>
    <p>×”×¢×ª×™×§×• ×•×©×œ×—×• ××ª ×”×§×™×©×•×¨ ×”×‘× ×œ×—×‘×¨×™× ×›×“×™ ×©×™×¦×˜×¨×¤×• ×œ×”×–×× ×”:</p>
    <p id="joinLinkContainer"></p>
    <table>
      <thead>
        <tr>
          <th>××¡×¢×“×”</th>
          <th>×©×</th>
          <th>×˜×œ×¤×•×Ÿ</th>
          <th>××•×¦×¨×™×</th>
          <th>×¡×›×•×</th>
          <th>×”×¢×¨×”</th>
        </tr>
      </thead>
      <tbody id="participantsBody">
      </tbody>
    </table>
    <p><strong>×¡×›×•× ×›×•×œ×œ:</strong> <span id="summaryTotal">0 â‚ª</span></p>
    <button onclick="closeOrder()">×¡×’×•×¨ ×”×–×× ×”</button>
  </div>

  <!-- ×›×¨×˜×™×¡ ×”×¦×˜×¨×¤×•×ª ×œ×”×–×× ×” (××¦×˜×¨×£) -->
  <div id="joinCard" class="card" style="display: none;">
    <h2>×”×¦×˜×¨×¤×•×ª ×œ×”×–×× ×”</h2>
    <label for="clientName">×©×</label>
    <input id="clientName" type="text" placeholder="×”×©× ×©×œ×š" required>
    <label for="clientPhone">×˜×œ×¤×•×Ÿ</label>
    <input id="clientPhone" type="tel" placeholder="×œ×“×•×’××”: 050-1234567">
    <label for="orderItems">×¤×¨×˜×™ ×”×–×× ×” (×©×•×¨×” ×—×“×©×” ×œ×›×œ ××•×¦×¨)</label>
    <textarea id="orderItems" rows="4" placeholder="×¦'×™×¤×¡\n×¦'×™×§×Ÿ ××§× ××’×˜×¡\n×©×ª×™×™×” ×§×œ×”"></textarea>
    <label for="clientNote">×”×¢×¨×”</label>
    <textarea id="clientNote" rows="2" placeholder="×”×¢×¨×” ×œ×©×œ×™×— ××• ×œ×× ×”×œ"></textarea>
    <button id="joinButton">×©×œ×— ×”×–×× ×”</button>
  </div>
</body>
</html>