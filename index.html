<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ניהול והצטרפות להזמנות</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f8f8;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #ffcc00;
      color: #000;
      padding: 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
    }
    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    h2 {
      margin-top: 0;
    }
    .hidden {
      display: none;
    }
    label {
      display: block;
      margin: 8px 0 4px;
    }
    input[type="text"], input[type="tel"], input[type="url"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #ffcc00;
      border: none;
      color: #000;
      padding: 10px 20px;
      margin-top: 15px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:disabled {
      background-color: #ddd;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: right;
    }
    th {
      background-color: #f0f0f0;
    }
    #menuContainer {
      margin-top: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      height: 400px;
      overflow-y: auto;
    }
    #menuFrame {
      width: 100%;
      height: 400px;
      border: none;
    }
    .message {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #e0ffe0;
      border: 1px solid #90ee90;
    }
    .error {
      background-color: #ffe0e0;
      border: 1px solid #ee9090;
    }
  </style>
</head>
<body>
  <header>הזמנות מקדונלד'ס - יצירת הזמנה והצטרפות</header>
  <main>
    <!-- Manager container -->
    <div id="managerContainer" class="hidden">
      <h2>פתיחת הזמנה חדשה</h2>
      <p>הזן את פרטיך כמנהל ההזמנה והזמנה חדשה תיווצר. תקבל קישור לשיתוף עם המשתתפים.</p>
      <form id="createForm">
        <label for="managerName">שם מנהל:</label>
        <input type="text" id="managerName" required />
        <label for="managerPhone">טלפון:</label>
        <input type="tel" id="managerPhone" required />
        <label for="payLink">קישור לתשלום (אופציונלי):</label>
        <input type="url" id="payLink" />
        <button type="submit">פתח הזמנה</button>
      </form>
      <div id="orderInfo" class="hidden">
        <h3>פרטי הזמנה</h3>
        <p>קישור להזמנה לשיתוף עם משתתפים:</p>
        <input type="text" id="shareLink" readonly style="width:100%;" />
        <button id="copyLinkBtn">העתק קישור</button>
        <h3>משתתפים</h3>
        <table id="participantsTable">
          <thead>
            <tr>
              <th>שם</th>
              <th>פריטים</th>
              <th>סה"כ (₪)</th>
              <th>הערות</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="managerMessage" class="message hidden"></div>
      </div>
    </div>
    <!-- Joiner container -->
    <div id="joinContainer" class="hidden">
      <h2>הצטרפות להזמנה</h2>
      <p>הזן את פרטיך ובחר מהתפריט כדי להצטרף להזמנה זו.</p>
      <div id="joinFormContainer">
        <label for="guestName">שם:</label>
        <input type="text" id="guestName" required />
        <label for="guestPhone">טלפון:</label>
        <input type="tel" id="guestPhone" />
        <label>הערות להזמנה (אופציונלי):</label>
        <input type="text" id="guestNotes" />
        <button id="openMenuBtn">פתח תפריט</button>
        <div id="menuContainer" class="hidden">
          <iframe id="menuFrame" src="mc_menu.html"></iframe>
        </div>
        <button id="addOrderBtn" disabled>הוסף הזמנה</button>
      </div>
      <div id="joinMessage" class="message hidden"></div>
    </div>
  </main>

  <!-- Firebase & application logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, addDoc, getDoc, onSnapshot, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // TODO: Replace with your Firebase project configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBF5lnU86OrzvlcHKNUf0h-2txKLgC5IJo",
      authDomain: "mcd-office-orders.firebaseapp.com",
      databaseURL: "https://mcd-office-orders-default-rtdb.firebaseio.com",
      projectId: "mcd-office-orders",
      storageBucket: "mcd-office-orders.appspot.com",
      messagingSenderId: "10595740776",
      appId: "1:10595740776:web:e59ad7fdbab2f93079dfdd",
      measurementId: "G-XTXX1Q6Y1W"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Elements
    const managerContainer = document.getElementById('managerContainer');
    const joinContainer = document.getElementById('joinContainer');
    const createForm = document.getElementById('createForm');
    const managerNameInput = document.getElementById('managerName');
    const managerPhoneInput = document.getElementById('managerPhone');
    const payLinkInput = document.getElementById('payLink');
    const orderInfo = document.getElementById('orderInfo');
    const shareLinkInput = document.getElementById('shareLink');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const participantsTableBody = document.querySelector('#participantsTable tbody');
    const managerMessage = document.getElementById('managerMessage');
    const joinFormContainer = document.getElementById('joinFormContainer');
    const guestNameInput = document.getElementById('guestName');
    const guestPhoneInput = document.getElementById('guestPhone');
    const guestNotesInput = document.getElementById('guestNotes');
    const openMenuBtn = document.getElementById('openMenuBtn');
    const menuContainer = document.getElementById('menuContainer');
    const menuFrame = document.getElementById('menuFrame');
    const addOrderBtn = document.getElementById('addOrderBtn');
    const joinMessage = document.getElementById('joinMessage');

    // Parse query parameters
    const urlParams = new URLSearchParams(window.location.search);
    const orderParam = urlParams.get('order');

    if (orderParam) {
      // Joiner mode
      showJoinPage(orderParam);
    } else {
      // Manager mode
      showManagerPage();
    }

    /**
     * Show the manager page UI
     */
    function showManagerPage() {
      managerContainer.classList.remove('hidden');
      // Handle order creation
      createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = managerNameInput.value.trim();
        const phone = managerPhoneInput.value.trim();
        const payLink = payLinkInput.value.trim();
        if (!name) return;
        try {
          // Generate new order document
          const orderRef = doc(collection(db, 'orders'));
          const orderId = orderRef.id;
          await setDoc(orderRef, {
            managerName: name,
            managerPhone: phone,
            payLink: payLink || '',
            status: 'open',
            createdAt: serverTimestamp()
          });
          // Update UI
          orderInfo.classList.remove('hidden');
          const joinLink = window.location.origin + window.location.pathname + '?order=' + orderId;
          shareLinkInput.value = joinLink;
          // Copy functionality
          copyLinkBtn.onclick = () => {
            navigator.clipboard.writeText(joinLink);
            alert('קישור הועתק ללוח');
          };
          // Listen for participant updates
          listenForParticipants(orderId);
        } catch (err) {
          managerMessage.className = 'message error';
          managerMessage.textContent = 'אירעה שגיאה ביצירת ההזמנה. אנא נסה שוב.';
          managerMessage.classList.remove('hidden');
        }
      });
    }

    /**
     * Real-time listener for participants
     * @param {string} orderId 
     */
    function listenForParticipants(orderId) {
      const participantsCol = collection(db, 'orders', orderId, 'participants');
      onSnapshot(participantsCol, (snapshot) => {
        // Clear current rows
        participantsTableBody.innerHTML = '';
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const tr = document.createElement('tr');
          const itemsList = (data.items || []).join(', ');
          tr.innerHTML = `
            <td>${data.name}</td>
            <td>${itemsList}</td>
            <td>${data.total?.toFixed(2) || ''}</td>
            <td>${data.notes || ''}</td>
          `;
          participantsTableBody.appendChild(tr);
        });
      });
    }

    /**
     * Show the join page UI
     * @param {string} orderId 
     */
    async function showJoinPage(orderId) {
      joinContainer.classList.remove('hidden');
      // Validate order exists and is open
      const orderRef = doc(db, 'orders', orderId);
      const orderSnap = await getDoc(orderRef);
      if (!orderSnap.exists()) {
        displayJoinError('לא נמצאה הזמנה. אולי הקישור שגוי או שההזמנה נסגרה.');
        return;
      }
      const orderData = orderSnap.data();
      if (orderData.status === 'closed') {
        displayJoinError('ההזמנה נסגרה ולא ניתן להצטרף אליה.');
        return;
      }
      // Set up menu button
      openMenuBtn.addEventListener('click', () => {
        // Toggle visibility of menu
        menuContainer.classList.toggle('hidden');
        // Enable add order button once menu is opened
        if (!menuContainer.classList.contains('hidden')) {
          addOrderBtn.disabled = false;
        }
      });
      // Add order event
      addOrderBtn.addEventListener('click', async () => {
        const guestName = guestNameInput.value.trim();
        const guestPhone = guestPhoneInput.value.trim();
        const notes = guestNotesInput.value.trim();
        if (!guestName) {
          displayJoinError('יש להזין שם.');
          return;
        }
        try {
          // Extract selected items from iframe
          const { items, total } = getSelectedItemsFromMenu();
          if (items.length === 0) {
            displayJoinError('אנא בחר לפחות פריט אחד מהתפריט.');
            return;
          }
          // Add participant document
          const participantRef = collection(db, 'orders', orderId, 'participants');
          await addDoc(participantRef, {
            name: guestName,
            phone: guestPhone || '',
            items: items,
            total: total,
            notes: notes || '',
            createdAt: serverTimestamp()
          });
          joinFormContainer.classList.add('hidden');
          joinMessage.className = 'message success';
          joinMessage.textContent = 'ההזמנה נוספה בהצלחה! תודה שהצטרפת.';
          joinMessage.classList.remove('hidden');
        } catch (err) {
          displayJoinError('אירעה שגיאה בהוספת ההזמנה. אנא נסה שוב.');
        }
      });
    }

    /**
     * Read selected items and total price from the menu iframe
     */
    function getSelectedItemsFromMenu() {
      const items = [];
      let total = 0;
      try {
        const doc = menuFrame.contentDocument || menuFrame.contentWindow.document;
        const checkedBoxes = doc.querySelectorAll('input[type="checkbox"]:checked');
        checkedBoxes.forEach((cb) => {
          const value = cb.value;
          const price = parseFloat(cb.getAttribute('data-price') || '0');
          items.push(value);
          total += price;
        });
      } catch (err) {
        console.error('Cannot access menu frame:', err);
      }
      return { items, total };
    }

    /**
     * Display an error message in the join page
     */
    function displayJoinError(msg) {
      joinMessage.className = 'message error';
      joinMessage.textContent = msg;
      joinMessage.classList.remove('hidden');
    }
  </script>
</body>
</html>